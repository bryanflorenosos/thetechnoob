+++
author = "Bryan Florenosos"
title = "Basic IPSec L2L VPN using Crypto Maps"
date = "2021-04-24"
description = "How to configure basic L2L ipsec vpn"
tags = [
    "network",
    "security",
]
+++

This is for my reference on how to actually build a site to site ipsec vpn using crypto-maps. This is the most basic and has the fundamentals.  

Basically IPsec VPN has Two Phases, Phase 1 and Phase 2.

### Phase 1
Phase 1 is only concerned in protecting the VPN tunnel session. The protocol that is used in this phase is **ISAKMP**/**IKE** and it is using **UDP 500**. There are **three main things** that are needed on both ends and this are the Key (either psk or rsa), encryption and a hashing algorithm. But basically below paremeters needs to match on both ends in order to establish the phase 1 tunnel. These parameters are (H.A.G.L.E):  

**Hashing** for data integrity (md5/sha)  
**Authentication** (certs or preshared key (PSK))  
**Group** (Diffie-Hellman group)  
**Lifetime** (how long will the tunnel be up for (seconds)  
**Encryption** for data confidentiality (AES, 3DES, AES-256)  

Below reference are recommended from Cisco, It should be kept in mind that these protocols are not used for data encryption/protection. It is for protecting key negotiation process before the start of VPN process.  
{{< bokya src="img/phase1table.jpg" alt="Bad Lighthouse Performance" >}}  
*Avoid*  
    Algorithms marked as avoid are vulnerable to modern attacks and should not be used to protect sensitive information.  

*Legacy*  
    Algorithms marked as legacy provide acceptable security level. Such algorithms should only be used in situations where interoperability is required or in case of deviceâ€™s limitation etc.  

*Acceptable*  
    These algorithms are safe from modern attacks and provide adequate security level.  

*NGE - Next Generation Encryption*  
    New algorithms have been designed in order to meet the security and scalability requirements for the next two decades.  

If both end meet's the same and correct requirements, the Authentication method for example a PSK key will encrypt the session and in turn protecting it, after this happens the **Session Key** will be dynamically created and the Session Key exchanged happens, this session key is generated by the **DH Group** or the **Diffie-Hellman group**. The default lifetime for a session is **3600 seconds** or **1 hour** and then status will always be IDLE, after this timer expires the DH group will wake up again and create a new Session Key, please do note that the protection of phase 1 only happens once.  

### Phase 2  
As mentioned before phase 1 is only concerned in the protection of the vpn tunnel session. **Phase 2** actually is where the encryption and protection of data exchange happens. The protocol used during this phase is **ESP** and it is using **protocol 50**.
Three main things also is required key, encryption and a hash. They key for the second tunnel already happened in the exchange in Phase 1 this **key** is the dynamic *session key*. Basically we only need to define in the configuration syntax the encryption and hasing algorithm during phase 2.  


 

