+++
author = "Bryan Florenosos"
title = "IPSEC VPN"
date = "2021-04-24"
description = "What is IPSec L2L"
tags = [
    "network",
    "security",
]
+++

*NOTE: having a vpn doesn't mean you have auto security as a network administrator its our duty to secure our data on an unsecured medium such as the internet*

## What is IPSec? 
IPSec stands for **IP security**. As the name suggests, it is used for the security of general IP traffic. The power of IPsec lies in its ability to support multiple protocols and algorithms. It also incorporates new advancements in encryption and hashing protocols. The main objective of IPSec is to provide CIA (confidentiality, integrity and authentication) for virtual networks used in current networking environments. IPSec makes sure the above objectives are in action by the time packet enters a VPN tunnel until it reaches the other end of tunnel.

Basically IPsec VPN has Two Phases, Phase 1 and Phase 2.

### Phase 1 (Session Establishment)
Phase 1 is only concerned in protecting the VPN tunnel session. The protocol that is used in this phase is **ISAKMP**/**IKE** and it is using **UDP 500**. There are **three main things** that are needed on both ends and this are the Key (either psk or rsa), encryption and a hashing algorithm. But basically below paremeters needs to match on both ends in order to establish the phase 1 tunnel. These parameters are (H.A.G.L.E):  

> **Hashing** for data integrity (md5/sha)  
> **Authentication** (certs or preshared key (PSK))  
> **Group** (Diffie-Hellman group)  
> **Lifetime** (how long will the tunnel be up for (seconds)  
> **Encryption** for data confidentiality (AES, 3DES, AES-256)  

Two modes can be used to define this phase 1 tunnel namely:  

**Main mode.**  
**a.** Main mode uses more packets and as a result, processing power more than the aggressive mode. Six different messages (three pair of messages) are exchanged between negotiating peers in main mode:  
**b.** First pair consists of IKEv1 security policies configure on device. One of the peer (initiator) starts sending one or more IKEv1 policies, and the other peer (responder) responds with its choice from the policies.  
**c.** Second pair includes DH public key exchange. DH creates a shared key as per DH group being exchanged in first pair and then encrypts a random number, which is then exchanged between VPN peers.  
**d.** Third pair is used for ISAKMP authentication. Each pair authenticates their validity by using either pre-shared key or digital certificate.  

**Aggressive mode.**   
**a.** Main goal of aggressive mode is same as main mode. Instead of six, this type for IKE phase 1 tunnel negotiation uses three messages. The overall process involves following steps:  
**b.** The initiator sends randomly generated number being signed by DH group, IKEv1 policies and so on.  
**c.** The other peer (responder) authenticates the packet and sends back accepted IKEv1 policies, nonces (the randomly generate number signed by DH group) and identification hash so that exchange gets complete.  
**d.** The initiator authenticates the receiving packets and sends identification hash to the responder.  


Below reference are recommended from Cisco, It should be kept in mind that these protocols are not used for data encryption/protection. It is for protecting key negotiation process before the start of VPN process.  
{{< bokya src="img/phase1table.jpg" alt="Bad Lighthouse Performance" >}}  
*Avoid*  
    Algorithms marked as avoid are vulnerable to modern attacks and should not be used to protect sensitive information.  

*Legacy*  
    Algorithms marked as legacy provide acceptable security level. Such algorithms should only be used in situations where interoperability is required or in case of device’s limitation etc.  

*Acceptable*  
    These algorithms are safe from modern attacks and provide adequate security level.  

*NGE - Next Generation Encryption*  
    New algorithms have been designed in order to meet the security and scalability requirements for the next two decades.  

If both end meet's the same and correct requirements, the Authentication method for example a PSK key will encrypt the session and in turn protecting it, after this happens the **Session Key** will be dynamically created and the Session Key exchanged happens, this session key is generated by the **DH Group** or the **Diffie-Hellman group**. The default lifetime for a session is **3600 seconds** or **1 hour** and then status will always be IDLE, after this timer expires the DH group will wake up again and create a new Session Key, please do note that the protection of phase 1 only happens once.  





### Phase 2  (Secure Data Transfer)
As mentioned before phase 1 is only concerned in the protection of the vpn tunnel session. **Phase 2** actually is where the encryption and protection of data exchange happens. The protocol used during this phase is **ESP** and it is using **protocol 50**.
Three main things also is required key, encryption and a hash. They key for the second tunnel already happened in the exchange in Phase 1 this **key** is the dynamic *session key*. Basically we only need to define in the configuration syntax the encryption and hasing algorithm during phase 2.    

Regardless of parameters selected within IKEv1 transform sets, the following pieces of information are always sent:
>* IPSec Encryption Algorithm (Options: DES, 3DES, AES)
>* IPSec Authentication Algorithm (Options: MD5, SHA-1)
>* IPSec Protocol (AH or ESP)
>* IPSec SA Lifetime (seconds or kilobytes)
>* IPSec Mode of Operation (Transport or Tunnel).

**Transform Sets** 
A transform set is a combination of individual IPSec transforms designed to enact a specific security policy for traffic. During the ISAKMP IPSec security association negotiation that occurs in IKE phase 2 quick mode, the peers agree to use a particular transform set for protecting a particular data flow. Transform sets combine the following IPSec factors:  
a. Mechanism for payload authentication—AH transform  
b.  Mechanism for payload encryption—ESP transform  
c.  IPSec mode (transport versus tunnel)  

**IPSec Tunnel Mode.** Being the default mode set in Cisco devices, tunnel mode protects the entire IP packet from originating device. It means for every original packet, another packet is generated with new IP header and send over the untrusted network to the VPN peer located on other end of logical connection. Tunnel mode is commonly used in case of Site-to-Site VPN where two secure IPSec gateways are connected over public internet using IPSec VPN connection. Tunnel mode is used when original IP packets are source and destination addresses of secure IPSec peers.  

**IPSec Transport Mode.** In transport mode, IPSec VPN secures the data field or payload of originating IP traffic by using encryption, hashing or both. New IPSec headers encapsulate only payload field while the original IP headers remain unchanged. For example, securing the management traffic of router is a perfect example of IPSec VPN implementation using transport mode. From configuration point of view, both tunnel and transport modes are defined in configuration of transform set.  