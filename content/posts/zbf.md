+++
author = "Bryan Florenosos"
title = "Zone Based Firewall Configuration"
date = "2021-04-14"
description = "ZBF Configuration"
tags = [
    "security",
]
+++

##### Zone Based Firewall (ZBF)

Allows a router to act as a stateful firewall, where we define and allocate security zones.
Just like a typical firewall interzone traffic is denied by default, unless specified by a rule/policy and Intrazone traffic is allowed by default.

**Note:** *The zone-based firewall feature requires a security license.*

{{< figure src="/images/zbf.jpg" title="Topology" >}}

###### Create the Zones

* `zone security CORPORATE`
* `zone security INTERNET`
* `zone security GUEST`

###### Assign the Interfaces to Zones

`interface Tunnel1`   
`zone-member security CORPORATE`  

`interface Gi1`  
 `zone-member security INTERNET`  

`interface Vlan50`  
 `description GUEST-WIFI`  
`zone-member security GUEST`  

*Configure Zone-Pair Policies to define the traffic that should be allowed thru the Zone-based Firewall. Zone-pair policies are between a pair of zones. It is directional. Each initiating Zone require a separate policy.*

###### Classify the traffic using a special Class-map for Zone-based Firewalls.

*Basically an **object-group** will act as a container in my example they are a collection of two IP addresses but this can be network address, ports etc., we will call this inside our Access-list configuration.*

`object-group network googleDNS`  
 `host 8.8.8.8`  
 `host 8.8.4.4`  
`ip access-list extended public-IP`  
 `permit tcp any object-group googleDNS eq 443`  
 `permit icmp any object-group googleDNS`  

*The **inspect** command will inspect traffic in layer 4 and 7*  
`class-map type inspect match-any public-IP`  
 `match access-group name public-IP`  
 
`class-map type inspect match-any GuestWeb`  
 `match protocol http`  
 `match protocol https`  
 `match protocol dns`   
 `match protocol icmp`  

`ip access-list extended self_to_INTERNET`  
`permit icmp any any`  
 `permit udp any any eq domain`  
`class-map type inspect match-any self_to_INTERNET`  
 `match access-group name self_to_INTERNET`  

`class-map type inspect match-any CORPORATE_to_INTERNET`  
 `match protocol icmp`  
 `match protocol dns`  

`ip access-list extended allowipsec`  
 `permit esp any any`  
 `permit udp any any eq isakmp`  
 `permit udp any any eq non500-isakmp`  
 `permit udp any eq isakmp any`  
 `permit udp any eq non500-isakmp any`  
`class-map type inspect match-any INTERNET_to_self_ipsec`  
 `match access-group name allowipsec`  

`object-group network proxy`  
 `165.225.98.0 255.255.255.0`  
 `165.225.226.0 255.255.254.0`  
`ip access-list extended allow-proxy`  
 `permit tcp any object-group proxy eq 443`  
 `permit tcp any object-group proxy eq www`  
 `permit icmp any object-group proxy`  
`class-map type inspect match-any proxyserver`  
 `match access-group name allow-proxy`  

###### Specify the action in a Policy Map for Zone-based Firewall.

`policy-map type inspect CORPORATE_to_self`  
 `class class-default`  
  `pass`  

`policy-map type inspect GUEST_to_INTERNET`  
 `class type inspect GuestWeb`  
  `inspect`  
 `class class-default`  
  `drop`  

`policy-map type inspect self_to_INTERNET`  
 `class type inspect INTERNET_to_self_ipsec`  
  `pass`  
 `class type inspect self_to_INTERNET`  
  `inspect`  
 `class class-default`  
  `drop log`  

`policy-map type inspect CORPORATE_to_INTERNET`  
 `class type inspect CORPORATE_to_INTERNET`  
  `inspect`  
 `class type inspect proxyserver`  
  `inspect`  
 `class type inspect public-IP`  
  `inspect`  
 `class class-default`  
  `drop log`  

`policy-map type inspect INTERNET_to_self`  
 `class type inspect INTERNET_to_self_ipsec`  
  `pass`  
 `class class-default`  
  `drop`  

###### Apply the Policy to the Zone-Pair.

* *The **self** keyword/syntax is a default self zone. The self zone is a system-defined zone which does not have any interfaces as members. A zone pair that includes the self zone, along with the associated policy, applies to traffic directed to the device or traffic generated by the device. It does not apply to traffic through the device. Note that if you select a self zone, you cannot configure inspect policing.*

`zone-pair security CORPORATE_to_INTERNET source CORPORATE destination INTERNET`  
 `service-policy type inspect CORPORATE_to_INTERNET`  

`zone-pair security CORPORATE_to_self source CORPORATE destination self`  
 `service-policy type inspect CORPORATE_to_self`  

 `zone-pair security GUEST_to_INTERNET source GUEST destination INTERNET`  
 `service-policy type inspect GUEST_to_INTERNET`  

 `zone-pair security INTERNET_to_self source INTERNET destination self`  
 `service-policy type inspect INTERNET_to_self`  

`zone-pair security self_to_CORPORATE source self destination CORPORATE`  
 `service-policy type inspect self_to_CORPORATE`  

 `zone-pair security self_to_INTERNET source self destination INTERNET`  
 `service-policy type inspect self_to_INTERNET`  

 ###### Verification Syntax:

 *To verify, use the following command:*  

sh policy-map type inspect zone-pair CORPORATE_to_INTERNET  sessions  





